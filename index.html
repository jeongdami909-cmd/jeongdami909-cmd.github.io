<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lena's Library</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
:root {
  /* ë°°ê²½ìƒ‰: ì€ì€í•œ ì›œí™”ì´íŠ¸(ì•„ì´ë³´ë¦¬) */
  --bg-color: #fdfdf6; 
  /* í¬ì¸íŠ¸ ìƒ‰ìƒ: ë”¥ ë¸”ë£¨ */
  --accent-blue: #003f7f;
  --text-main: #222222;
  --text-muted: #666666;
  --border-color: #eeeeee;

  /* ë·°ì–´ ì„¤ì •ì„ ìœ„í•œ ë™ì  ë³€ìˆ˜ */
  --post-font-size: 1rem;
  --post-line-height: 1.8;
  --post-padding: 30px;
}

* { margin:0; padding:0; box-sizing:border-box; }
body { font-family: 'Noto Sans KR', sans-serif; background: var(--bg-color); color: var(--text-main); min-height: 100vh; padding-bottom: 80px; }

/* í—¤ë” ìŠ¤íƒ€ì¼ */
.site-header { text-align: center; padding: 50px 20px 30px; display: flex; flex-direction: column; align-items: center; }
.profile-pic { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
.site-title { font-family:'Playfair Display', serif; font-size: 2.5rem; font-weight:700; color: var(--accent-blue); margin-bottom: 8px; }
.site-subtitle { font-size: 0.9rem; color: var(--text-muted); font-weight: 300; max-width: 500px; margin: 0 auto 20px; line-height: 1.6; }

/* êµ¬ê¸€ ê²€ìƒ‰ì°½ */
.google-search-container { width: 100%; max-width: 320px; margin-bottom: 25px; }
.google-search-form { 
    display: flex; align-items: center; background: white; border-radius: 50px; 
    padding: 6px 15px; box-shadow: 0 4px 10px rgba(0, 63, 127, 0.08); 
    border: 1px solid var(--border-color); transition: 0.3s;
}
.google-search-form:focus-within { border-color: var(--accent-blue); box-shadow: 0 4px 12px rgba(0, 63, 127, 0.15); }
.google-search-form button { background: none; border: none; font-size: 1rem; cursor: pointer; color: #888; padding: 0; margin-right: 8px; }
.google-search-form input { flex: 1; border: none; outline: none; background: transparent; font-family: 'Noto Sans KR', sans-serif; font-size: 0.85rem; color: var(--text-main); }
.google-search-form input::placeholder { color: #bbb; }

.btn-new { background: transparent; border: 1px solid var(--accent-blue); color: var(--accent-blue); padding: 8px 24px; border-radius: 50px; cursor: pointer; font-size: 0.85rem; transition: 0.3s; font-weight: 500;}
.btn-new:hover { background: var(--accent-blue); color: white; }

/* ì±…ì¥ ê·¸ë¦¬ë“œ ìŠ¤íƒ€ì¼ */
.container { max-width: 1000px; margin: 0 auto; padding: 0 20px; }
.book-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 40px 25px; }

.book-card { cursor: pointer; display: flex; flex-direction: column; align-items: center; text-align: center; transition: transform 0.2s ease; }
.book-card:hover { transform: translateY(-5px); }
.book-cover { width: 100%; aspect-ratio: 2 / 3; object-fit: cover; border-radius: 2px 6px 6px 2px; box-shadow: -2px 0 5px rgba(0,0,0,0.05), 5px 5px 15px rgba(0,0,0,0.1); margin-bottom: 15px; background: #eee; }
.book-title { font-size: 0.95rem; font-weight: 700; line-height: 1.3; margin-bottom: 5px; word-break: keep-all; color: var(--text-main); }
.book-author { font-size: 0.8rem; color: var(--text-muted); }

/* ëª¨ë‹¬ ê³µí†µ */
.modal-overlay { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 1000; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(5px); }
.modal-overlay.open { display: flex; }
.modal-content { background: white; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; padding: 40px; border-radius: 16px; box-shadow: 0 20px 50px rgba(0,0,0,0.1); position: relative; border: 1px solid var(--border-color); }
.close-btn { position: absolute; top: 20px; right: 25px; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); background: none; border: none; }

/* ìƒì„¸ ë³´ê¸° ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
.detail-layout { display: flex; flex-direction: column; align-items: center; text-align: center; }
.detail-cover { width: 160px; aspect-ratio: 2/3; object-fit: cover; border-radius: 2px 6px 6px 2px; box-shadow: 5px 10px 20px rgba(0,0,0,0.15); margin-bottom: 25px; }

/* ìŒì„± ë“£ê¸° ë²„íŠ¼ */
.tts-btn { background: #f0f7ff; border: 1px solid var(--accent-blue); color: var(--accent-blue); padding: 6px 16px; border-radius: 30px; font-size: 0.85rem; font-weight: 700; cursor: pointer; transition: 0.2s; margin-bottom: 20px; }
.tts-btn:hover { background: var(--accent-blue); color: white; }

.detail-title { font-family:'Playfair Display', serif; font-size: 2rem; font-weight: 700; margin-bottom: 5px; color: var(--text-main); }
.detail-author { font-size: 1rem; color: var(--text-muted); margin-bottom: 30px; }

/* ë·°ì–´ ë³€ìˆ˜ê°€ ì ìš©ë˜ëŠ” í…ìŠ¤íŠ¸ ì˜ì—­ */
.reader-area { width: 100%; padding: var(--post-padding); box-sizing: border-box; }

.section-title { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 2px; color: var(--text-muted); margin-bottom: 15px; font-weight: 700; display: block; }
.detail-quote { 
    font-family:'Playfair Display', serif; 
    font-size: calc(var(--post-font-size) + 0.15rem); 
    line-height: var(--post-line-height); 
    font-style: italic; color: var(--accent-blue); margin-bottom: 35px; word-break: keep-all; 
}
.detail-review { 
    font-size: var(--post-font-size); 
    line-height: var(--post-line-height); 
    color: #444; text-align: left; border-top: 1px solid var(--border-color); 
    padding-top: 30px; white-space: pre-wrap; 
}

.detail-actions { margin-top: 40px; display: flex; gap: 10px; width: 100%; justify-content: center; border-top: 1px solid var(--border-color); padding-top: 20px; }
.action-btn { background: #f5f5f5; border: none; padding: 10px 20px; border-radius: 6px; font-size: 0.85rem; cursor: pointer; color: var(--text-main); font-weight: 500; transition: 0.2s; }
.action-btn:hover { background: #e0e0e0; }
.action-btn.delete { color: #e74c3c; }

/* ì…ë ¥/ìˆ˜ì • í¼ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
.form-group { margin-bottom: 20px; text-align: left; }
.form-group label { display: block; font-size: 0.8rem; font-weight: 700; color: var(--text-muted); margin-bottom: 8px; }
.form-group input, .form-group textarea { width: 100%; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: 8px; font-family: inherit; font-size: 0.95rem; outline: none; background: #fafafa; }
.form-group input:focus, .form-group textarea:focus { border-color: var(--accent-blue); background: white; }
.form-group textarea { min-height: 120px; resize: vertical; }

.file-box { border: 1px dashed #ccc; padding: 15px; text-align: center; border-radius: 8px; margin-bottom: 20px; cursor: pointer; color: #888; font-size: 0.9rem; background: #fafafa; transition: 0.2s; }
.file-box:hover { border-color: var(--accent-blue); color: var(--accent-blue); background: #f0f7ff; }

.save-btn { width: 100%; background: var(--accent-blue); color: white; border: none; padding: 15px; border-radius: 8px; font-size: 1rem; font-weight: 700; cursor: pointer; margin-top: 10px; }

/* ğŸ’¡ ë·°ì–´ ì„¤ì • í”Œë¡œíŒ… ë²„íŠ¼ ë° ëª¨ë‹¬ */
.fab-viewer {
    position: fixed; bottom: 30px; right: 30px; width: 55px; height: 55px;
    background: white; color: var(--accent-blue); border: 1px solid var(--accent-blue);
    border-radius: 50%; box-shadow: 0 4px 15px rgba(0, 63, 127, 0.2);
    font-size: 1.2rem; font-weight: 700; display: flex; align-items: center; justify-content: center;
    cursor: pointer; z-index: 100; transition: 0.2s; font-family: 'Playfair Display', serif;
}
.fab-viewer:hover { transform: scale(1.05); background: var(--accent-blue); color: white; }

.viewer-modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(4px); }
.viewer-modal-overlay.open { display: flex; }
.viewer-modal-content { background: white; width: 100%; max-width: 380px; padding: 30px; border-radius: 16px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); position: relative; max-height: 90vh; overflow-y: auto; }
.v-close-btn { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; cursor: pointer; color: #aaa; background: none; border: none; }
.setting-group { margin-bottom: 22px; }
.setting-group label { display: flex; justify-content: space-between; font-size: 0.9rem; font-weight: 600; color: #555; margin-bottom: 10px; }
.setting-group input[type="range"] { width: 100%; accent-color: var(--accent-blue); cursor: pointer; }
.setting-group select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-family: inherit; font-size: 0.9rem; outline: none; }

/* ì„¤ì •ì°½ ì•ˆì˜ ì„¹ì…˜ êµ¬ë¶„ì„  */
.settings-divider { border-top: 1px dashed #ddd; margin: 25px 0; }

</style>
</head>
<body>

<header class="site-header">
  <img src="https://images.unsplash.com/photo-1544716278-ca5e3f4abd8c?auto=format&fit=crop&w=200&q=80" alt="Profile" class="profile-pic">
  <h1 class="site-title">Lena's Library</h1>
  <p class="site-subtitle">ë‚˜ë¥¼ êµ¬ì„±í•˜ëŠ” ë¬¸ì¥ë“¤ê³¼ ê¹Šì€ ì‚¬ìœ ì˜ ê¸°ë¡ë“¤. ì±… í‘œì§€ë¥¼ í´ë¦­í•˜ë©´ ìƒì„¸í•œ ë¶ë¦¬í¬íŠ¸ë¥¼ ì½ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
  
  <div class="google-search-container">
      <form action="https://www.google.com/search" method="GET" target="_blank" class="google-search-form" onsubmit="return true;">
          <button type="submit">ğŸ”</button>
          <input type="search" name="q" placeholder="ì±… ì •ë³´ êµ¬ê¸€ ê²€ìƒ‰..." required>
      </form>
  </div>

  <button class="btn-new" onclick="openForm()">+ ìƒˆë¡œìš´ ì±… ê¸°ë¡í•˜ê¸°</button>
</header>

<main class="container">
  <div class="book-grid" id="bookGrid"></div>
</main>

<div class="modal-overlay" id="detailModal">
  <div class="modal-content">
    <button class="close-btn" onclick="closeModal('detailModal')">Ã—</button>
    <div class="detail-layout" id="detailContent"></div>
  </div>
</div>

<div class="modal-overlay" id="formModal">
  <div class="modal-content">
    <button class="close-btn" onclick="closeModal('formModal')">Ã—</button>
    <h2 id="formTitle" style="font-family:'Playfair Display', serif; margin-bottom: 25px; text-align: center; color: var(--accent-blue);">Add a Book</h2>
    
    <div class="form-group">
      <label>ì±… ì œëª©</label>
      <input type="text" id="f-title" placeholder="ì˜ˆ: ì•ˆë‚˜ ì¹´ë ˆë‹ˆë‚˜">
    </div>
    <div class="form-group">
      <label>ì§€ì€ì´</label>
      <input type="text" id="f-author" placeholder="ì˜ˆ: ë ˆí”„ í†¨ìŠ¤í† ì´">
    </div>
    
    <div class="file-box" onclick="document.getElementById('f-img-file').click()" id="fileBoxText">
        + ì±… í‘œì§€ ì‚¬ì§„ ì²¨ë¶€ (í„°ì¹˜)
    </div>
    <input type="file" id="f-img-file" hidden accept="image/*">
    
    <div class="form-group">
      <label>ë°œì·Œ (ê¸°ì–µí•˜ê³  ì‹¶ì€ ë¬¸ì¥)</label>
      <textarea id="f-quote" placeholder="ì¸ìƒ ê¹Šì—ˆë˜ êµ¬ì ˆì„ ì ì–´ì£¼ì„¸ìš”."></textarea>
    </div>
    <div class="form-group">
      <label>ë‚˜ë§Œì˜ ë¶ë¦¬í¬íŠ¸ / ê°ìƒí‰</label>
      <textarea id="f-review" placeholder="ì ì§„ì ìœ¼ë¡œ ë“œëŸ¬ë‚˜ëŠ” ë‚´ë©´ì˜ ê¹Šì´ë‚˜, ì‚¬íšŒì  ë¶€ì¡°ë¦¬ì— ëŒ€í•œ ìƒê°ë“¤ì„ ììœ ë¡­ê²Œ ì ì–´ë³´ì„¸ìš”."></textarea>
    </div>
    <button class="save-btn" onclick="handleSave()">ê¸°ë¡ ì €ì¥í•˜ê¸°</button>
  </div>
</div>

<button class="fab-viewer" onclick="openViewerModal()" title="ë·°ì–´ ì„¤ì •">Aa</button>

<div class="viewer-modal-overlay" id="viewerModal">
    <div class="viewer-modal-content">
        <button class="v-close-btn" onclick="closeViewerModal()">Ã—</button>
        <h3 style="margin-top:0; margin-bottom: 20px; font-size:1.2rem; color: var(--accent-blue);">ë…ì„œ ë·°ì–´ ì„¤ì •</h3>
        
        <div class="setting-group">
            <label><span>ê¸€ì í¬ê¸°</span> <span id="val-fontSize"></span></label>
            <input type="range" id="v-fontSize" min="0.8" max="1.6" step="0.05" oninput="updateViewerSettings()">
        </div>
        <div class="setting-group">
            <label><span>ì¤„ ê°„ê²©</span> <span id="val-lineHeight"></span></label>
            <input type="range" id="v-lineHeight" min="1.4" max="2.5" step="0.1" oninput="updateViewerSettings()">
        </div>
        <div class="setting-group">
            <label><span>ì•ˆìª½ ì—¬ë°±</span> <span id="val-padding"></span></label>
            <input type="range" id="v-padding" min="10" max="60" step="2" oninput="updateViewerSettings()">
        </div>

        <div class="settings-divider"></div>
        <h3 style="margin-top:0; margin-bottom: 20px; font-size:1.1rem; color: var(--accent-blue);">ìŒì„±(TTS) ì„¤ì •</h3>

        <div class="setting-group">
            <label><span>ëª©ì†Œë¦¬ ì¢…ë¥˜</span></label>
            <select id="v-ttsVoice" onchange="updateViewerSettings()">
                <option value="">ê¸°ë³¸ ëª©ì†Œë¦¬</option>
            </select>
        </div>
        <div class="setting-group">
            <label><span>ì½ê¸° ì†ë„</span> <span id="val-ttsRate"></span></label>
            <input type="range" id="v-ttsRate" min="0.5" max="2.0" step="0.1" oninput="updateViewerSettings()">
        </div>
        
        <button class="action-btn" style="width:100%; margin-top:10px; padding:12px; background:#f0f0f0; border:none;" onclick="resetViewerSettings()">ê¸°ë³¸ê°’ìœ¼ë¡œ ë³µêµ¬</button>
    </div>
</div>

<script>
// --- ğŸ’¡ ë·°ì–´ & ìŒì„± ì„¤ì • ê´€ë¦¬ ë¡œì§ ---
const defaultViewer = { fontSize: 1.0, lineHeight: 1.8, padding: 30, ttsRate: 1.0, ttsVoice: '' };
let viewerSettings = JSON.parse(localStorage.getItem('lenaViewerSettingsV2')) || defaultViewer;

// ì‚¬ìš© ê°€ëŠ¥í•œ ëª©ì†Œë¦¬ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
let availableVoices = [];
function populateVoices() {
    // í•œêµ­ì–´ ìŒì„±ë§Œ í•„í„°ë§
    availableVoices = window.speechSynthesis.getVoices().filter(v => v.lang.includes('ko'));
    const voiceSelect = document.getElementById('v-ttsVoice');
    voiceSelect.innerHTML = '<option value="">ê¸°ë³¸ ëª©ì†Œë¦¬ (ì‹œìŠ¤í…œ ê¸°ë³¸)</option>';
    
    availableVoices.forEach(voice => {
        const option = document.createElement('option');
        option.value = voice.voiceURI;
        
        // ì´ë¦„ì— ë‚¨/ì—¬ íŒíŠ¸ê°€ ìˆìœ¼ë©´ í‘œì‹œí•´ì£¼ê¸°
        let displayName = voice.name;
        if(displayName.toLowerCase().includes('female')) displayName += ' (ì—¬ì„±)';
        else if(displayName.toLowerCase().includes('male')) displayName += ' (ë‚¨ì„±)';
        
        option.textContent = displayName;
        if (viewerSettings.ttsVoice === voice.voiceURI) option.selected = true;
        voiceSelect.appendChild(option);
    });
}
// ë¸Œë¼ìš°ì €ê°€ ìŒì„± ëª©ë¡ì„ ë¡œë“œ ì™„ë£Œí•˜ë©´ ì‹¤í–‰
window.speechSynthesis.onvoiceschanged = populateVoices;

function applyViewerSettings() {
    // í…ìŠ¤íŠ¸/ì—¬ë°± ë””ìì¸ ì ìš©
    document.documentElement.style.setProperty('--post-font-size', viewerSettings.fontSize + 'rem');
    document.documentElement.style.setProperty('--post-line-height', viewerSettings.lineHeight);
    document.documentElement.style.setProperty('--post-padding', viewerSettings.padding + 'px');
    
    // UI ìŠ¬ë¼ì´ë” ê°’ ë™ê¸°í™”
    document.getElementById('v-fontSize').value = viewerSettings.fontSize;
    document.getElementById('v-lineHeight').value = viewerSettings.lineHeight;
    document.getElementById('v-padding').value = viewerSettings.padding;
    document.getElementById('v-ttsRate').value = viewerSettings.ttsRate || 1.0;
    
    // UI í…ìŠ¤íŠ¸ ê°’ ë™ê¸°í™”
    document.getElementById('val-ttsRate').textContent = (viewerSettings.ttsRate || 1.0) + 'x';
    
    if(document.getElementById('v-ttsVoice').options.length > 1) {
        document.getElementById('v-ttsVoice').value = viewerSettings.ttsVoice || '';
    }
}

function updateViewerSettings() {
    viewerSettings = {
        fontSize: document.getElementById('v-fontSize').value,
        lineHeight: document.getElementById('v-lineHeight').value,
        padding: document.getElementById('v-padding').value,
        ttsRate: document.getElementById('v-ttsRate').value,
        ttsVoice: document.getElementById('v-ttsVoice').value
    };
    localStorage.setItem('lenaViewerSettingsV2', JSON.stringify(viewerSettings));
    applyViewerSettings();
}

function resetViewerSettings() {
    viewerSettings = { ...defaultViewer };
    localStorage.setItem('lenaViewerSettingsV2', JSON.stringify(viewerSettings));
    applyViewerSettings();
}

function openViewerModal() { document.getElementById('viewerModal').classList.add('open'); }
function closeViewerModal() { document.getElementById('viewerModal').classList.remove('open'); }

applyViewerSettings(); 


// --- ë©”ì¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ ê¸°ëŠ¥ ---
const defaultBooks = [
  { id: 1, title: "ì•ˆë‚˜ ì¹´ë ˆë‹ˆë‚˜", author: "ë ˆí”„ í†¨ìŠ¤í† ì´", img: "https://images.unsplash.com/photo-1589829085413-56de8ae18c73?auto=format&fit=crop&w=600&q=80", quote: "í–‰ë³µí•œ ê°€ì •ì€ ëª¨ë‘ ì—‡ë¹„ìŠ·í•˜ê³ , ë¶ˆí–‰í•œ ê°€ì •ì€ ë¶ˆí–‰í•œ ì´ìœ ê°€ ì œê°ê¸° ë‹¤ë¥´ë‹¤.", review: "ì¸ê°„ ë³¸ì„±ì— ëŒ€í•œ ë‚ ì¹´ë¡œìš´ í†µì°°ë ¥. ìºë¦­í„°ì˜ ê²‰ëª¨ìŠµì´ ë²—ê²¨ì§€ë©° ì§„ì •í•œ ë‚´ë©´ì´ ë“œëŸ¬ë‚˜ëŠ” ê³¼ì •ì´ ì••ê¶Œì´ë‹¤." },
  { id: 2, title: "í˜¸ë°€ë°­ì˜ íŒŒìˆ˜ê¾¼", author: "J.D. ìƒë¦°ì €", img: "https://images.unsplash.com/photo-1544947950-fa07a98d237f?auto=format&fit=crop&w=600&q=80", quote: "ë‚˜ëŠ” ëŠ˜ ë„“ì€ í˜¸ë°€ë°­ì—ì„œ ê¼¬ë§ˆë“¤ì´ ì¬ë¯¸ìˆê²Œ ë†€ê³  ìˆëŠ” ëª¨ìŠµì„ ìƒìƒí•˜ê³¤ í–ˆì–´.", review: "ì‚¬íšŒì  ë¶€ì¡°ë¦¬ì™€ í—ˆìœ„ì— ëŒ€í•œ í™€ë“ ì˜ ì‹œì„ . ë³µì¡í•˜ê³  ì–´ì§€ëŸ¬ìš´ ì„¸ìƒ ì†ì—ì„œ ìˆœìˆ˜í•¨ì„ ì§€í‚¤ë ¤ëŠ” ëª¸ë¶€ë¦¼." }
];

let books = JSON.parse(localStorage.getItem('lena_premium_lib_v3'));
if (!books || books.length === 0) {
    books = defaultBooks;
    localStorage.setItem('lena_premium_lib_v3', JSON.stringify(books));
}

let currentEditId = null;
let currentSelectedImg = ""; 
let currentSpeakingId = null;

document.getElementById('f-img-file').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if(file) {
        const reader = new FileReader();
        reader.onload = (ev) => { 
            currentSelectedImg = ev.target.result; 
            document.getElementById('fileBoxText').innerHTML = "âœ”ï¸ í‘œì§€ ì²¨ë¶€ ì™„ë£Œ (í´ë¦­ ì‹œ ë³€ê²½)";
            document.getElementById('fileBoxText').style.borderColor = "var(--accent-blue)";
            document.getElementById('fileBoxText').style.color = "var(--accent-blue)";
        };
        reader.readAsDataURL(file);
    }
});

function renderGrid() {
    const grid = document.getElementById('bookGrid');
    grid.innerHTML = '';
    
    books.forEach(b => {
        const coverSrc = b.img || "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='300' viewBox='0 0 200 300'%3E%3Crect width='200' height='300' fill='%23f0f0f0'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-size='14px' fill='%23aaa'%3ENo Cover%3C/text%3E%3C/svg%3E";
        
        grid.innerHTML += `
            <div class="book-card" onclick="openDetail(${b.id})">
                <img src="${coverSrc}" class="book-cover" alt="cover">
                <div class="book-title">${b.title}</div>
                <div class="book-author">${b.author}</div>
            </div>
        `;
    });
}

function openModal(id) { document.getElementById(id).classList.add('open'); document.body.style.overflow = 'hidden'; }
function closeModal(id) { 
    document.getElementById(id).classList.remove('open'); document.body.style.overflow = 'auto'; 
    if(window.speechSynthesis.speaking) {
        window.speechSynthesis.cancel();
        currentSpeakingId = null;
    }
}

// ğŸ’¡ í…ìŠ¤íŠ¸ ìŒì„± ë³€í™˜ (TTS) ì‹¤í–‰ í•¨ìˆ˜
function toggleTTS(id) {
    if (window.speechSynthesis.speaking) {
        window.speechSynthesis.cancel();
        if (currentSpeakingId === id) {
            currentSpeakingId = null;
            return; 
        }
    }

    const b = books.find(item => item.id === id);
    if(!b) return;
    
    let textToRead = b.title + "....... ì§€ì€ì´, " + (b.author || "ë¯¸ìƒ") + "....... ";
    if(b.quote) textToRead += "ë°œì·Œë¬¸. " + b.quote + "....... ";
    if(b.review) textToRead += "ê°ìƒí‰. " + b.review;

    const utterance = new SpeechSynthesisUtterance(textToRead);
    utterance.lang = 'ko-KR'; 
    
    // ğŸ’¡ ì„¤ì •ì—ì„œ ì €ì¥ëœ ì½ê¸° ì†ë„ ì ìš©
    utterance.rate = parseFloat(viewerSettings.ttsRate) || 1.0; 
    
    // ğŸ’¡ ì„¤ì •ì—ì„œ ì„ íƒëœ ëª©ì†Œë¦¬ ì ìš©
    if (viewerSettings.ttsVoice) {
        const selectedVoice = availableVoices.find(v => v.voiceURI === viewerSettings.ttsVoice);
        if (selectedVoice) {
            utterance.voice = selectedVoice;
        }
    }
    
    utterance.onend = function() { currentSpeakingId = null; };

    window.speechSynthesis.speak(utterance);
    currentSpeakingId = id;
}

function openDetail(id) {
    const b = books.find(item => item.id === id);
    if(!b) return;
    
    const coverSrc = b.img || "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='300' viewBox='0 0 200 300'%3E%3Crect width='200' height='300' fill='%23f0f0f0'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-size='14px' fill='%23aaa'%3ENo Cover%3C/text%3E%3C/svg%3E";
    
    const content = document.getElementById('detailContent');
    content.innerHTML = `
        <img src="${coverSrc}" class="detail-cover">
        <h2 class="detail-title">${b.title}</h2>
        <div class="detail-author">${b.author}</div>
        
        <button class="tts-btn" onclick="toggleTTS(${b.id})">ğŸ”Š ì´ ê¸°ë¡ ë“£ê¸°</button>
        
        <div class="reader-area">
            ${b.quote ? `
            <span class="section-title">Highlight</span>
            <div class="detail-quote">"${b.quote}"</div>` : ''}
            
            ${b.review ? `
            <span class="section-title">Book Report</span>
            <div class="detail-review">${b.review}</div>` : ''}
        </div>
        
        <div class="detail-actions">
            <button class="action-btn" onclick="openForm(${b.id})">ìˆ˜ì •í•˜ê¸°</button>
            <button class="action-btn delete" onclick="deleteBook(${b.id})">ì‚­ì œí•˜ê¸°</button>
        </div>
    `;
    
    openModal('detailModal');
}

function openForm(id = null) {
    currentEditId = id;
    if(id) {
        closeModal('detailModal');
        const b = books.find(item => item.id === id);
        document.getElementById('f-title').value = b.title;
        document.getElementById('f-author').value = b.author || '';
        document.getElementById('f-quote').value = b.quote || '';
        document.getElementById('f-review').value = b.review || '';
        currentSelectedImg = b.img || "";
        
        if(b.img) {
            document.getElementById('fileBoxText').innerHTML = "âœ”ï¸ ê¸°ì¡´ í‘œì§€ ìœ ì§€ (í´ë¦­ ì‹œ ë³€ê²½)";
            document.getElementById('fileBoxText').style.color = "var(--accent-blue)";
            document.getElementById('fileBoxText').style.borderColor = "var(--accent-blue)";
        } else {
            document.getElementById('fileBoxText').innerHTML = "+ ì±… í‘œì§€ ì‚¬ì§„ ì²¨ë¶€ (í„°ì¹˜)";
            document.getElementById('fileBoxText').style.color = "#888";
            document.getElementById('fileBoxText').style.borderColor = "#ccc";
        }
        document.getElementById('formTitle').innerText = "Edit Book";
    } else {
        document.getElementById('f-title').value = '';
        document.getElementById('f-author').value = '';
        document.getElementById('f-quote').value = '';
        document.getElementById('f-review').value = '';
        currentSelectedImg = "";
        document.getElementById('fileBoxText').innerHTML = "+ ì±… í‘œì§€ ì‚¬ì§„ ì²¨ë¶€ (í„°ì¹˜)";
        document.getElementById('fileBoxText').style.color = "#888";
        document.getElementById('fileBoxText').style.borderColor = "#ccc";
        document.getElementById('formTitle').innerText = "Add a Book";
    }
    openModal('formModal');
}

function handleSave() {
    const title = document.getElementById('f-title').value;
    const author = document.getElementById('f-author').value;
    const quote = document.getElementById('f-quote').value;
    const review = document.getElementById('f-review').value;

    if(!title) return alert("ì±… ì œëª©ì€ ê¼­ ì…ë ¥í•´ ì£¼ì„¸ìš”.");

    const data = { id: currentEditId || Date.now(), title, author, img: currentSelectedImg, quote, review };

    if(currentEditId) {
        const idx = books.findIndex(b => b.id === currentEditId);
        books[idx] = data;
    } else {
        books.unshift(data);
    }
    
    localStorage.setItem('lena_premium_lib_v3', JSON.stringify(books));
    renderGrid();
    closeModal('formModal');
    if(currentEditId) openDetail(currentEditId);
}

function deleteBook(id) {
    if(!confirm("ì´ ê¸°ë¡ì„ ì™„ì „íˆ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    books = books.filter(b => b.id !== id);
    localStorage.setItem('lena_premium_lib_v3', JSON.stringify(books));
    closeModal('detailModal');
    renderGrid();
}

renderGrid();
</script>
</body>
</html>

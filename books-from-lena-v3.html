<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Books from Lena</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Noto+Serif+KR:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --paper: #f4ede0;
  --paper2: #fdfaf4;
  --aged: #ddd0b8;
  --ink: #1c1208;
  --rust: #8b2a0f;
  --gold: #b8893a;
  --muted: #705e48;
  --soft: #a89070;
  --card-bg: #fefcf6;
  --shadow: 0 4px 28px rgba(28,18,8,0.11);
  --overlay: rgba(28,18,8,0.6);
}
* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family: 'Noto Serif KR', serif;
  background: var(--paper);
  color: var(--ink);
  min-height: 100vh;
}
body::after {
  content:''; position:fixed; inset:0;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='200' height='200' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
  pointer-events:none; z-index:999;
}

/* â”€â”€ HEADER â”€â”€ */
.site-header {
  padding: 48px 52px 30px;
  border-bottom: 1px solid var(--aged);
  display: flex; align-items: flex-end; justify-content: space-between; gap: 20px;
  animation: fadeDown .6s ease both;
}
.eyebrow {
  font-family:'Playfair Display',serif; font-style:italic;
  font-size:12px; letter-spacing:.2em; color:var(--gold); text-transform:uppercase; margin-bottom:8px;
}
.site-title { font-family:'Playfair Display',serif; font-size:clamp(2rem,5vw,3.2rem); font-weight:700; line-height:1.05; }
.site-title em { color:var(--rust); font-style:normal; }
.site-desc { margin-top:10px; font-size:13.5px; color:var(--muted); font-weight:300; letter-spacing:.04em; }

.btn-primary {
  flex-shrink:0; background:var(--rust); color:#fff; border:none;
  font-family:'Noto Serif KR',serif; font-size:13.5px;
  padding:12px 22px; border-radius:3px; cursor:pointer; letter-spacing:.04em;
  transition:background .2s, transform .15s;
}
.btn-primary:hover { background:#6e1f09; transform:translateY(-1px); }

/* â”€â”€ FILTER BAR â”€â”€ */
.filter-bar {
  padding: 16px 52px; border-bottom:1px solid var(--aged);
  display:flex; gap:8px; flex-wrap:wrap; align-items:center;
  animation:fadeDown .7s ease both;
}
.filter-label { font-size:11px; letter-spacing:.15em; text-transform:uppercase; color:var(--soft); margin-right:4px; }
.tag-filter {
  background:none; border:1px solid var(--aged); color:var(--muted);
  font-family:'Noto Serif KR',serif; font-size:12px;
  padding:5px 14px; border-radius:20px; cursor:pointer; transition:all .2s;
}
.tag-filter:hover, .tag-filter.active { background:var(--rust); border-color:var(--rust); color:#fff; }

/* â”€â”€ BOOK LIST â”€â”€ */
.book-list { padding:40px 52px 100px; display:flex; flex-direction:column; gap:32px; }

/* â”€â”€ BOOK CARD â”€â”€ */
.book-card {
  background:var(--card-bg); border:1px solid var(--aged);
  border-radius:6px; box-shadow:var(--shadow); overflow:hidden;
  position:relative; animation:fadeUp .6s ease both;
  transition:box-shadow .3s;
}
.book-card:hover { box-shadow:0 8px 40px rgba(28,18,8,0.17); }
.book-card::before {
  content:''; position:absolute; left:0; top:0; bottom:0; width:5px;
  background:linear-gradient(to bottom,var(--rust),#5a1a05);
}

.card-inner { padding:30px 32px 32px 40px; }

.card-top {
  display:flex; align-items:flex-start; justify-content:space-between; gap:16px; margin-bottom:14px;
}
.book-title { font-family:'Playfair Display',serif; font-size:1.55rem; font-weight:700; line-height:1.2; }
.book-subtitle { font-size:12.5px; color:var(--soft); letter-spacing:.1em; margin-top:4px; }

.card-actions { display:flex; gap:7px; flex-shrink:0; }
.icon-btn {
  background:none; border:1px solid var(--aged); color:var(--muted);
  width:34px; height:34px; border-radius:4px; cursor:pointer; font-size:15px;
  display:flex; align-items:center; justify-content:center; transition:all .2s;
}
.icon-btn:hover { border-color:var(--rust); color:var(--rust); background:rgba(139,42,15,0.05); }
.icon-btn.del:hover { border-color:#c0392b; color:#c0392b; }

.card-meta { display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:20px; }
.author-chip { font-family:'Playfair Display',serif; font-style:italic; font-size:13.5px; color:var(--muted); }
.tag-chip {
  font-size:11px; padding:3px 10px; border-radius:20px;
  background:rgba(139,42,15,0.07); color:var(--rust);
  letter-spacing:.08em; border:1px solid rgba(139,42,15,0.15);
}

.card-sections { display:flex; flex-direction:column; gap:14px; }

/* Section blocks */
.section-block {
  border-left:3px solid var(--aged);
  padding:14px 18px;
  background:rgba(244,237,224,0.4);
  border-radius:0 4px 4px 0;
}
.section-block.quote  { border-left-color:var(--rust); background:rgba(139,42,15,0.04); }
.section-block.review { border-left-color:var(--gold); background:rgba(184,137,58,0.05); }

.section-label {
  font-size:9.5px; letter-spacing:.22em; text-transform:uppercase;
  font-weight:600; margin-bottom:8px;
}
.section-block.background .section-label { color:var(--soft); }
.section-block.quote      .section-label { color:var(--rust); }
.section-block.review     .section-label { color:var(--gold); }

.section-text {
  font-size:14px; line-height:2; color:var(--ink); font-weight:300; white-space:pre-wrap;
}
.section-block.quote .section-text {
  font-family:'Playfair Display',serif; font-style:italic; font-size:15px; line-height:1.85;
}
.section-block.quote .section-text::before { content:'\201C'; margin-right:2px; }
.section-block.quote .section-text::after  { content:'\201D'; margin-left:2px;  }

/* Photo grid */
.photo-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(150px,1fr)); gap:10px; margin-top:4px; }
.photo-thumb {
  aspect-ratio:4/3; object-fit:cover; border-radius:4px; border:1px solid var(--aged);
  cursor:pointer; transition:transform .2s, box-shadow .2s; width:100%;
}
.photo-thumb:hover { transform:scale(1.03); box-shadow:0 4px 16px rgba(28,18,8,0.2); }

.no-content { font-size:13px; color:var(--soft); font-style:italic; }

/* â”€â”€ LIGHTBOX â”€â”€ */
.lightbox {
  display:none; position:fixed; inset:0;
  background:rgba(0,0,0,0.9); z-index:1000;
  align-items:center; justify-content:center;
}
.lightbox.open { display:flex; }
.lightbox img { max-width:90vw; max-height:88vh; border-radius:4px; }
.lightbox-close {
  position:absolute; top:20px; right:28px;
  color:#fff; font-size:28px; cursor:pointer; background:none; border:none;
}

/* â”€â”€ MODAL â”€â”€ */
.modal-bg {
  display:none; position:fixed; inset:0;
  background:var(--overlay); z-index:500;
  align-items:center; justify-content:center; padding:20px;
}
.modal-bg.open { display:flex; }

.modal {
  background:var(--paper2); border:1px solid var(--aged); border-radius:8px;
  width:100%; max-width:640px; max-height:90vh; overflow-y:auto;
  box-shadow:0 24px 64px rgba(0,0,0,0.3); animation:popIn .3s ease both;
}

.modal-header {
  padding:24px 28px 18px; border-bottom:1px solid var(--aged);
  display:flex; align-items:center; justify-content:space-between;
  position:sticky; top:0; background:var(--paper2); z-index:10;
}
.modal-title { font-family:'Playfair Display',serif; font-size:1.2rem; font-weight:700; }
.modal-close { background:none; border:none; font-size:22px; color:var(--muted); cursor:pointer; }

.modal-body { padding:26px 28px; display:flex; flex-direction:column; gap:20px; }

.field-group { display:flex; flex-direction:column; gap:7px; }
label { font-size:10.5px; letter-spacing:.18em; text-transform:uppercase; color:var(--gold); font-weight:600; }
.hint { font-size:11.5px; color:var(--soft); margin-top:2px; }

input[type=text], textarea, select {
  font-family:'Noto Serif KR',serif; font-size:14px;
  background:var(--paper); border:1px solid var(--aged); border-radius:4px;
  padding:10px 14px; color:var(--ink); width:100%; transition:border-color .2s; resize:vertical;
}
input[type=text]:focus, textarea:focus, select:focus { outline:none; border-color:var(--gold); }

/* Section editor */
.section-editors { display:flex; flex-direction:column; gap:10px; }

.section-row {
  display:grid; grid-template-columns:130px 1fr 36px; gap:8px; align-items:flex-start;
}
.section-row select { width:100%; }
.section-row textarea { min-height:90px; }

.btn-add-section {
  background:none; border:1.5px dashed var(--aged); color:var(--muted);
  font-family:'Noto Serif KR',serif; font-size:13px; padding:9px; border-radius:4px;
  cursor:pointer; text-align:center; width:100%; transition:all .2s; margin-top:4px;
}
.btn-add-section:hover { border-color:var(--gold); color:var(--gold); }

/* Photo upload */
.upload-zone {
  border:2px dashed var(--aged); border-radius:6px; padding:24px 20px;
  text-align:center; cursor:pointer; transition:border-color .2s, background .2s;
  display:flex; flex-direction:column; align-items:center; gap:8px;
}
.upload-zone:hover { border-color:var(--gold); background:rgba(184,137,58,0.04); }
.upload-zone .icon { font-size:28px; }
.upload-zone p { font-size:13px; color:var(--muted); }
.upload-zone small { font-size:11.5px; color:var(--soft); }
input[type=file] { display:none; }

.preview-row { display:flex; flex-wrap:wrap; gap:10px; }
.preview-item { position:relative; width:80px; height:64px; }
.preview-item img { width:100%; height:100%; object-fit:cover; border-radius:4px; border:1px solid var(--aged); }
.preview-item button {
  position:absolute; top:-6px; right:-6px;
  width:20px; height:20px; background:var(--rust); color:#fff;
  border:none; border-radius:50%; font-size:11px; cursor:pointer;
  display:flex; align-items:center; justify-content:center;
}

.modal-footer {
  padding:18px 28px 24px; display:flex; justify-content:flex-end; gap:10px;
  border-top:1px solid var(--aged);
  position:sticky; bottom:0; background:var(--paper2);
}
.btn-save {
  background:var(--rust); color:#fff; border:none;
  font-family:'Noto Serif KR',serif; font-size:13.5px;
  padding:11px 24px; border-radius:3px; cursor:pointer; transition:background .2s;
}
.btn-save:hover { background:#6e1f09; }
.btn-cancel {
  background:none; border:1px solid var(--aged); color:var(--muted);
  font-family:'Noto Serif KR',serif; font-size:13.5px;
  padding:11px 20px; border-radius:3px; cursor:pointer; transition:all .2s;
}
.btn-cancel:hover { border-color:var(--rust); color:var(--rust); }

.del-row-btn {
  background:none; border:1px solid var(--aged); color:var(--soft);
  width:36px; height:36px; border-radius:4px; cursor:pointer; font-size:14px;
  display:flex; align-items:center; justify-content:center; transition:all .2s;
  margin-top:2px;
}
.del-row-btn:hover { border-color:#c0392b; color:#c0392b; }

/* â”€â”€ EMPTY STATE â”€â”€ */
.empty-state { display:none; text-align:center; padding:80px 20px; color:var(--soft); }
.empty-state.show { display:block; }
.empty-state h3 { font-family:'Playfair Display',serif; font-size:1.4rem; margin-bottom:10px; }
.empty-state p { font-size:14px; margin-bottom:28px; }

/* â”€â”€ ANIMATIONS â”€â”€ */
@keyframes fadeDown { from{opacity:0;transform:translateY(-16px)} to{opacity:1;transform:translateY(0)} }
@keyframes fadeUp   { from{opacity:0;transform:translateY(20px)}  to{opacity:1;transform:translateY(0)} }
@keyframes popIn    { from{opacity:0;transform:scale(.96)}        to{opacity:1;transform:scale(1)} }

/* â”€â”€ RESPONSIVE â”€â”€ */
@media(max-width:640px){
  .site-header{padding:28px 20px 22px;flex-direction:column;align-items:flex-start;}
  .filter-bar{padding:14px 20px;}
  .book-list{padding:28px 20px 60px;}
  .card-inner{padding:22px 20px 24px 28px;}
  .section-row{grid-template-columns:1fr 36px;grid-template-rows:auto auto;}
  .section-row select{grid-column:1/-1;}
}
</style>
</head>
<body>

<!-- HEADER -->
<header class="site-header">
  <div>
    <p class="eyebrow">ë‚˜ë§Œì˜ ë””ì§€í„¸ ì„œì¬</p>
    <h1 class="site-title">Books from <em>Lena</em></h1>
    <p class="site-desc">ì½ì€ ê²ƒë“¤, ê¸°ì–µí•  ê²ƒë“¤, ë‚¨ê²¨ë‘ëŠ” ê²ƒë“¤.</p>
  </div>
  <button class="btn-primary" onclick="openAddModal()">ï¼‹ ì±… ì¶”ê°€í•˜ê¸°</button>
</header>

<!-- FILTER BAR -->
<div class="filter-bar" id="filterBar">
  <span class="filter-label">ì§€ì—­</span>
  <button class="tag-filter active" data-tag="all"  onclick="filterTag(this)">ì „ì²´</button>
  <button class="tag-filter"        data-tag="ì•„ì‹œì•„" onclick="filterTag(this)">ì•„ì‹œì•„</button>
  <button class="tag-filter"        data-tag="ìœ ëŸ½"   onclick="filterTag(this)">ìœ ëŸ½</button>
  <button class="tag-filter"        data-tag="ë¯¸êµ­"   onclick="filterTag(this)">ë¯¸êµ­</button>
  <button class="tag-filter"        data-tag="ê·¸ ë°–"  onclick="filterTag(this)">ê·¸ ë°–</button>
</div>

<!-- BOOK LIST -->
<main class="book-list" id="bookList">
  <div class="empty-state" id="emptyState">
    <h3>ì•„ì§ ì±…ì´ ì—†ì–´ìš”</h3>
    <p>ì²« ë²ˆì§¸ ì±…ì„ ê¸°ë¡í•´ë³´ì„¸ìš”.</p>
    <button class="btn-primary" onclick="openAddModal()">ï¼‹ ì±… ì¶”ê°€í•˜ê¸°</button>
  </div>
</main>

<!-- LIGHTBOX -->
<div class="lightbox" id="lightbox" onclick="closeLightbox()">
  <button class="lightbox-close">âœ•</button>
  <img id="lightboxImg" src="" alt="">
</div>

<!-- MODAL -->
<div class="modal-bg" id="modalBg">
  <div class="modal" id="modalBox">
    <div class="modal-header">
      <h2 class="modal-title" id="modalTitle">ì±… ì¶”ê°€í•˜ê¸°</h2>
      <button class="modal-close" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body">

      <div class="field-group">
        <label>ì œëª© *</label>
        <input type="text" id="f-title" placeholder="ì±… ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;">
        <div class="field-group">
          <label>ì €ì</label>
          <input type="text" id="f-author" placeholder="ì €ìëª…">
        </div>
        <div class="field-group">
          <label>ì›ì œ / ë¶€ì œ</label>
          <input type="text" id="f-subtitle" placeholder="å¦»å¦¾æˆç¾¤">
        </div>
      </div>

      <div class="field-group">
        <label>íƒœê·¸</label>
        <input type="text" id="f-tags" placeholder="ì†Œì„¤, ì¤‘êµ­ë¬¸í•™, ì¶”ì²œ">
        <p class="hint">ì§€ì—­ íƒœê·¸: ì•„ì‹œì•„ / ìœ ëŸ½ / ë¯¸êµ­ / ê·¸ ë°– Â· ì‰¼í‘œë¡œ êµ¬ë¶„í•´ì„œ ì…ë ¥í•˜ì„¸ìš”</p>
      </div>

      <div class="field-group">
        <label>ë‚´ìš© ì„¹ì…˜</label>
        <p class="hint">ë°°ê²½ ì§€ì‹, ë°œì·Œë¬¸, ì†Œê°ì„ ììœ ë¡­ê²Œ ì¶”ê°€í•˜ì„¸ìš”</p>
        <div class="section-editors" id="sectionEditors"></div>
        <button class="btn-add-section" onclick="addSectionRow()">ï¼‹ ì„¹ì…˜ ì¶”ê°€</button>
      </div>

      <div class="field-group">
        <label>ì‚¬ì§„</label>
        <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
          <span class="icon">ğŸ–¼</span>
          <p>í´ë¦­í•´ì„œ ì‚¬ì§„ ì—…ë¡œë“œ</p>
          <small>ì—¬ëŸ¬ ì¥ ë™ì‹œì— ì„ íƒ ê°€ëŠ¥ Â· JPG, PNG, WEBP</small>
        </div>
        <input type="file" id="fileInput" accept="image/*" multiple onchange="handleFiles(event)">
        <div class="preview-row" id="previewRow" style="margin-top:12px;"></div>
      </div>

    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeModal()">ì·¨ì†Œ</button>
      <button class="btn-save" onclick="saveBook()">ì €ì¥í•˜ê¸°</button>
    </div>
  </div>
</div>

<script>
// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const KEY = 'lena_books_v2';
let books = [];
let editingId = null;
let pendingPhotos = []; // [{src}]
let currentTag = 'all';

function persist() { localStorage.setItem(KEY, JSON.stringify(books)); }

function boot() {
  try { const r = localStorage.getItem(KEY); if (r) books = JSON.parse(r); } catch(e) {}
  if (!books.length) {
    books = [{
      id: Date.now(),
      title: 'ì²˜ì²©ì„±êµ°',
      subtitle: 'å¦»å¦¾æˆç¾¤',
      author: 'ì‘¤í‰',
      tags: ['ì†Œì„¤', 'ì•„ì‹œì•„'],
      sections: [
        { type:'background', text:'1920ë…„ëŒ€ ì¤‘êµ­ì˜ íì‡„ì ì¸ ê°€ë¶€ì¥ì œ ì‚¬íšŒë¥¼ ë‹¤ë£¬ ì†Œì„¤ì…ë‹ˆë‹¤. ì›ì‘ì˜ \'ìš°ë¬¼\'ì€ ì—¬ì„±ì˜ ì–µì••ì„ ìƒì§•í•©ë‹ˆë‹¤.' }
      ],
      photos: []
    }];
    persist();
  }
}

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render() {
  const list = document.getElementById('bookList');
  list.querySelectorAll('.book-card').forEach(e => e.remove());

  const shown = currentTag === 'all'
    ? books
    : books.filter(b => (b.tags||[]).includes(currentTag));

  document.getElementById('emptyState').classList.toggle('show', shown.length === 0);

  shown.forEach((book, i) => {
    const card = makeCard(book, i);
    list.appendChild(card);
  });

  rebuildFilterBar();
}

function makeCard(book, i) {
  const el = document.createElement('div');
  el.className = 'book-card';
  el.style.animationDelay = (i * 0.07) + 's';
  el.dataset.id = book.id;

  const tags = (book.tags||[]).map(t => `<span class="tag-chip">${x(t)}</span>`).join('');

  const sections = (book.sections||[]).map(s => {
    const labels = { background:'ë°°ê²½ ì§€ì‹', quote:'ë°œì·Œë¬¸', review:'ì†Œê°' };
    const cls = `section-block ${s.type}`;
    return `<div class="${cls}">
      <p class="section-label">${labels[s.type]||s.type}</p>
      <p class="section-text">${x(s.text)}</p>
    </div>`;
  }).join('');

  const photos = book.photos && book.photos.length
    ? `<div class="section-block background">
        <p class="section-label" style="color:var(--soft)">ì‚¬ì§„</p>
        <div class="photo-grid">
          ${book.photos.map(p=>`<img class="photo-thumb" src="${p.src}" onclick="lb('${p.src.replace(/'/g,"\\'")}')">`).join('')}
        </div>
      </div>`
    : '';

  const empty = !sections && !photos
    ? '<p class="no-content">í¸ì§‘ ë²„íŠ¼ìœ¼ë¡œ ë‚´ìš©ì„ ì¶”ê°€í•´ë³´ì„¸ìš”.</p>'
    : '';

  el.innerHTML = `
    <div class="card-inner">
      <div class="card-top">
        <div>
          <h2 class="book-title">${x(book.title)}</h2>
          ${book.subtitle ? `<p class="book-subtitle">${x(book.subtitle)}</p>` : ''}
        </div>
        <div class="card-actions">
          <button class="icon-btn" title="í¸ì§‘" onclick="openEdit(${book.id})">âœ</button>
          <button class="icon-btn del" title="ì‚­ì œ" onclick="del(${book.id})">âœ•</button>
        </div>
      </div>
      <div class="card-meta">
        ${book.author ? `<span class="author-chip">${x(book.author)}</span>` : ''}
        ${tags}
      </div>
      <div class="card-sections">${sections}${photos}${empty}</div>
    </div>`;
  return el;
}

function rebuildFilterBar() {
  const bar = document.getElementById('filterBar');
  bar.querySelectorAll('.tag-filter').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.tag === currentTag);
  });
}

function filterTag(btn) {
  currentTag = btn.dataset.tag;
  render();
}

function x(s) {
  if (!s) return '';
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAddModal() {
  editingId = null; pendingPhotos = [];
  document.getElementById('modalTitle').textContent = 'ì±… ì¶”ê°€í•˜ê¸°';
  document.getElementById('f-title').value = '';
  document.getElementById('f-subtitle').value = '';
  document.getElementById('f-author').value = '';
  document.getElementById('f-tags').value = '';
  document.getElementById('sectionEditors').innerHTML = '';
  document.getElementById('previewRow').innerHTML = '';
  document.getElementById('modalBg').classList.add('open');
}

function openEdit(id) {
  const b = books.find(b => b.id===id);
  if (!b) return;
  editingId = id;
  pendingPhotos = (b.photos||[]).map(p=>({...p}));
  document.getElementById('modalTitle').textContent = 'ì±… í¸ì§‘í•˜ê¸°';
  document.getElementById('f-title').value = b.title||'';
  document.getElementById('f-subtitle').value = b.subtitle||'';
  document.getElementById('f-author').value = b.author||'';
  document.getElementById('f-tags').value = (b.tags||[]).join(', ');
  document.getElementById('sectionEditors').innerHTML = '';
  (b.sections||[]).forEach(s => addSectionRow(s));
  renderPreviews();
  document.getElementById('modalBg').classList.add('open');
}

function closeModal() {
  document.getElementById('modalBg').classList.remove('open');
}

document.getElementById('modalBg').addEventListener('click', e => {
  if (e.target === document.getElementById('modalBg')) closeModal();
});

// â”€â”€ SECTION ROWS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addSectionRow(existing) {
  const container = document.getElementById('sectionEditors');
  const row = document.createElement('div');
  row.className = 'section-row';
  const t = existing ? existing.type : 'background';
  row.innerHTML = `
    <select>
      <option value="background" ${t==='background'?'selected':''}>ğŸ“– ë°°ê²½ ì§€ì‹</option>
      <option value="quote"      ${t==='quote'?'selected':''}>âœï¸ ë°œì·Œë¬¸</option>
      <option value="review"     ${t==='review'?'selected':''}>ğŸ’¬ ì†Œê°</option>
    </select>
    <textarea placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...">${existing ? x(existing.text) : ''}</textarea>
    <button class="del-row-btn" onclick="this.closest('.section-row').remove()" title="ì‚­ì œ">âœ•</button>
  `;
  // Unescape textarea content properly
  if (existing) {
    row.querySelector('textarea').value = existing.text;
  }
  container.appendChild(row);
}

function collectSections() {
  return [...document.querySelectorAll('#sectionEditors .section-row')]
    .map(row => ({
      type: row.querySelector('select').value,
      text: row.querySelector('textarea').value.trim()
    }))
    .filter(s => s.text);
}

// â”€â”€ PHOTOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleFiles(e) {
  [...e.target.files].forEach(file => {
    const reader = new FileReader();
    reader.onload = ev => { pendingPhotos.push({ src: ev.target.result }); renderPreviews(); };
    reader.readAsDataURL(file);
  });
  e.target.value = '';
}

function renderPreviews() {
  const row = document.getElementById('previewRow');
  row.innerHTML = '';
  pendingPhotos.forEach((p, i) => {
    const div = document.createElement('div');
    div.className = 'preview-item';
    div.innerHTML = `<img src="${p.src}" alt=""><button onclick="rmPhoto(${i})">âœ•</button>`;
    row.appendChild(div);
  });
}

function rmPhoto(i) { pendingPhotos.splice(i,1); renderPreviews(); }

// â”€â”€ SAVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveBook() {
  const title = document.getElementById('f-title').value.trim();
  if (!title) { document.getElementById('f-title').focus(); return; }

  const tags = document.getElementById('f-tags').value
    .split(',').map(t=>t.trim()).filter(Boolean);

  const data = {
    id: editingId || Date.now(),
    title,
    subtitle: document.getElementById('f-subtitle').value.trim(),
    author:   document.getElementById('f-author').value.trim(),
    tags,
    sections: collectSections(),
    photos: [...pendingPhotos]
  };

  if (editingId) {
    const idx = books.findIndex(b=>b.id===editingId);
    if (idx>-1) books[idx] = data;
  } else {
    books.unshift(data);
  }

  persist();
  closeModal();
  render();
}

// â”€â”€ DELETE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function del(id) {
  if (!confirm('ì´ ì±…ì„ ì‚­ì œí• ê¹Œìš”?')) return;
  books = books.filter(b=>b.id!==id);
  persist();
  render();
}

// â”€â”€ LIGHTBOX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function lb(src) {
  document.getElementById('lightboxImg').src = src;
  document.getElementById('lightbox').classList.add('open');
}
function closeLightbox() {
  document.getElementById('lightbox').classList.remove('open');
  document.getElementById('lightboxImg').src = '';
}

document.addEventListener('keydown', e => {
  if (e.key==='Escape') { closeLightbox(); closeModal(); }
});

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
boot();
render();
</script>
</body>
</html>
